import{_ as e,u as a}from"./index-DkhJWZ0D.js";import{s as t}from"./sfx-Bhf_myqE.js";import{G as l}from"./GameGuide-Sg6BGPLx.js";import{u as s,j as n,k as i,t as r,q as o,H as u,B as d,l as c,p,s as v}from"./naive-ui-CtewNtT3.js";import{o as f,aC as g,bg as y,bF as m,bE as h,r as _,bf as k,bh as b,k as w,bi as x,aW as S,b7 as A,F as C,bk as B,bj as z,bn as N,b1 as j}from"./vendor-CBGg7cPT.js";const I={class:"pk-page"},R={key:0,class:"battle-replay"},D={class:"battle-header"},$={class:"fighter-avatar fa"},J={class:"fighter-hp-bar"},M={class:"fighter-avatar fb"},O={class:"fighter-hp-bar"},P={class:"rounds-log"},H={key:0,class:"action-dodge"},T={class:"action-dmg"},W={key:0,class:"action-crit"},G={key:1,class:"action-combo"},F={key:0},U={key:0,class:"stats-bar"},q={class:"stat-item"},E={class:"stat-num"},K={class:"stat-item win"},V={class:"stat-num"},L={class:"stat-item lose"},Q={class:"stat-num"},X={class:"stat-item reward"},Y={class:"stat-num"},Z={key:0,style:{"text-align":"center",padding:"30px 0"}},ee={class:"player-left"},ae={class:"player-av"},te={class:"player-info"},le={key:0,style:{"text-align":"center",padding:"30px 0"}},se={class:"h-left"},ne={class:"h-info"},ie=e({__name:"PK",setup(e){const ie=a(),re=s(),oe=_(!1),ue=_([]),de=_(!1),ce=_(!1),pe=_(!1),ve=_(null),fe=_(null);let ge=null,ye=null;const me=ie.getCombatPower(),he=_("lobby"),_e=_(null),ke=_([]),be=async()=>{const e=localStorage.getItem("xx_token")||localStorage.getItem("roon_auth_token");if(!e)return;const a={Authorization:`Bearer ${e}`};try{const[e,t]=await Promise.all([fetch("/api/pk/stats",{headers:a}),fetch("/api/pk/history",{headers:a})]);_e.value=await e.json();const l=await t.json();ke.value=l.records||[]}catch{}},we=e=>{const a=new Date(e);return`${a.getMonth()+1}/${a.getDate()} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},xe=()=>{const e=ie.getTotalStats();return{health:e.health,attack:e.attack,defense:e.defense,speed:e.speed,critRate:e.critRate,comboRate:e.comboRate,dodgeRate:e.dodgeRate,critDamageBoost:e.critDamageBoost,finalDamageReduce:e.finalDamageReduce}},Se=()=>{const e="https:"===location.protocol?"wss:":"ws:";ge=new WebSocket(`${e}//${location.host}/ws`),ge.onopen=()=>{oe.value=!0;const e=localStorage.getItem("xx_token")||localStorage.getItem("roon_auth_token");e&&(ge.send(JSON.stringify({type:"auth",token:e,name:ie.name})),setTimeout(()=>{ge.send(JSON.stringify({type:"pk_update_stats",stats:xe(),level:ie.level,realm:ie.realm,combatPower:me}))},500))},ge.onmessage=e=>{try{const a=JSON.parse(e.data);if("pk_players"===a.type&&(ue.value=a.players,de.value=!1),"pk_challenged"===a.type&&(ve.value=a,pe.value=!0,t.click()),"pk_challenge_sent"===a.type&&(ce.value=!0,re.info("æŒ‘æˆ˜å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹å›žåº”..."),setTimeout(()=>{ce.value=!1},3e4)),"pk_result"===a.type){fe.value=a,pe.value=!1,ce.value=!1,be();const e=localStorage.getItem("xx_wallet")||"";a.winnerName&&("A"===a.winner&&a.walletA===e||"B"===a.winner&&a.walletB===e)?(t.victory(),ie.spiritStones+=500,ie.saveData()):"draw"!==a.winner&&t.defeat()}"pk_declined"===a.type&&(ce.value=!1,re.warning(`${a.by} æ‹’ç»äº†ä½ çš„æŒ‘æˆ˜`)),"pk_error"===a.type&&(re.error(a.msg),ce.value=!1)}catch{}},ge.onclose=()=>{oe.value=!1,ye=setTimeout(Se,3e3)},ge.onerror=()=>{ge.close()}},Ae=()=>{ge&&1===ge.readyState&&(de.value=!0,ge.send(JSON.stringify({type:"pk_get_players"})))},Ce=()=>{ie.stopAutoCultivation(),ge&&1===ge.readyState&&ve.value&&(ge.send(JSON.stringify({type:"pk_accept",challengeId:ve.value.challengeId})),pe.value=!1)},Be=()=>{ge&&1===ge.readyState&&ve.value&&(ge.send(JSON.stringify({type:"pk_decline",challengeId:ve.value.challengeId})),pe.value=!1,ve.value=null)};return f(()=>{Se(),setTimeout(Ae,1e3),be()}),g(()=>{ye&&clearTimeout(ye),ge&&(ge.onclose=null,ge.close())}),(e,a)=>{const t=r,s=i,f=u,g=o,_=d,re=c,ye=v,be=p,xe=n;return k(),y("div",I,[m(l,null,{default:h(()=>[...a[3]||(a[3]=[b("p",null,[w("âš”ï¸ å’Œå…¶ä»–åœ¨çº¿çŽ©å®¶"),b("strong",null,"å®žæ—¶å¯¹æˆ˜")],-1),b("p",null,[w("ðŸ¤– è‡ªåŠ¨å›žåˆåˆ¶æˆ˜æ–—ï¼Œ"),b("strong",null,"å±žæ€§å†³å®šèƒœè´Ÿ")],-1),b("p",null,[w("ðŸ† èƒœåˆ©èŽ·å¾—"),b("strong",null,"500ç„°æ™¶"),w("å¥–åŠ±")],-1),b("p",null,"ðŸ’¡ æå‡è£…å¤‡ã€ç„°å…½ã€ç„°ä¸¹buffæ¥å¢žå¼ºæˆ˜åŠ›",-1)])]),_:1}),m(xe,null,{default:h(()=>[m(s,{justify:"end",style:{"margin-bottom":"8px"}},{default:h(()=>[m(t,{type:oe.value?"success":"error",size:"small"},{default:h(()=>[w(x(oe.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)]),_:1},8,["type"])]),_:1}),m(g,{show:pe.value,"onUpdate:show":a[0]||(a[0]=e=>pe.value=e),preset:"dialog",title:"âš”ï¸ æ”¶åˆ°æŒ‘æˆ˜ï¼","positive-text":"åº”æˆ˜","negative-text":"æ‹’ç»",onPositiveClick:Ce,onNegativeClick:Be},{default:h(()=>[m(s,{vertical:"",align:"center"},{default:h(()=>[a[5]||(a[5]=b("span",{style:{"font-size":"40px"}},"ðŸ—¡ï¸",-1)),m(f,{strong:""},{default:h(()=>{var e;return[w(x(null==(e=ve.value)?void 0:e.fromName),1)]}),_:1}),m(f,{depth:"3"},{default:h(()=>{var e;return[w("æˆ˜åŠ›: "+x(null==(e=ve.value)?void 0:e.fromCombatPower),1)]}),_:1}),m(f,{type:"warning"},{default:h(()=>[...a[4]||(a[4]=[w("å‘ä½ å‘èµ·äº†ç„°æ­¦æŒ‘æˆ˜ï¼",-1)])]),_:1})]),_:1})]),_:1},8,["show"]),fe.value?(k(),y("div",R,[b("div",D,[b("div",{class:S(["fighter",{winner:"A"===fe.value.winner}])},[b("div",$,x(fe.value.nameA[0]),1),m(f,{strong:""},{default:h(()=>[w(x(fe.value.nameA),1)]),_:1}),b("div",J,[b("div",{class:"fighter-hp-fill hp-a",style:A({width:fe.value.finalHpA/fe.value.maxHpA*100+"%"})},null,4)])],2),a[6]||(a[6]=b("div",{class:"vs-center"},[b("span",{class:"vs-text"},"VS")],-1)),b("div",{class:S(["fighter",{winner:"B"===fe.value.winner}])},[b("div",M,x(fe.value.nameB[0]),1),m(f,{strong:""},{default:h(()=>[w(x(fe.value.nameB),1)]),_:1}),b("div",O,[b("div",{class:"fighter-hp-fill hp-b",style:A({width:fe.value.finalHpB/fe.value.maxHpB*100+"%"})},null,4)])],2)]),b("div",P,[(k(!0),y(C,null,B(fe.value.rounds,e=>(k(),y("div",{key:e.round,class:"round-item"},[m(t,{size:"tiny",bordered:!1},{default:h(()=>[w("ç¬¬"+x(e.round)+"å›žåˆ",1)]),_:2},1024),(k(!0),y(C,null,B(e.actions,(e,a)=>(k(),y("div",{key:a,class:"action-item"},[b("span",{class:S(["action-attacker","A"===e.attacker?"side-a":"side-b"])},x("A"===e.attacker?fe.value.nameA:fe.value.nameB),3),e.isDodged?(k(),y("span",H,"è¢«é—ªé¿!")):(k(),y(C,{key:1},[b("span",T,"-"+x(e.damage),1),e.isCrit?(k(),y("span",W,"æš´å‡»!")):z("",!0),e.isCombo?(k(),y("span",G,"è¿žå‡»!")):z("",!0)],64))]))),128))]))),128))]),b("div",{class:S(["battle-result-banner","result-"+fe.value.winner])},["draw"===fe.value.winner?(k(),y("span",F,"âš–ï¸ å¹³å±€")):(k(),y(C,{key:1},[b("span",null,"ðŸ† "+x(fe.value.winnerName)+" èŽ·èƒœï¼",1),m(f,{type:"warning",style:{"font-size":"12px"}},{default:h(()=>[w("+"+x(fe.value.reward)+" ç„°æ™¶",1)]),_:1})],64))],2),m(_,{block:"",onClick:a[1]||(a[1]=e=>fe.value=null),style:{"margin-top":"12px"}},{default:h(()=>[...a[7]||(a[7]=[w("è¿”å›žå¤§åŽ…",-1)])]),_:1})])):(k(),N(s,{key:1,vertical:"",size:16},{default:h(()=>[m(re,{type:"info","show-icon":!1},{default:h(()=>[a[8]||(a[8]=w(" æˆ‘çš„æˆ˜åŠ›ï¼š",-1)),m(f,{strong:"",type:"warning"},{default:h(()=>[w(x(j(me)),1)]),_:1}),m(f,{depth:"3",style:{"margin-left":"12px"}},{default:h(()=>[w("èƒœè€…èŽ·å¾— "+x(500)+" ç„°æ™¶")]),_:1})]),_:1}),_e.value?(k(),y("div",U,[b("div",q,[b("span",E,x(_e.value.total),1),a[9]||(a[9]=b("span",{class:"stat-label"},"æ€»åœºæ¬¡",-1))]),b("div",K,[b("span",V,x(_e.value.wins),1),a[10]||(a[10]=b("span",{class:"stat-label"},"èƒœ",-1))]),b("div",L,[b("span",Q,x(_e.value.losses),1),a[11]||(a[11]=b("span",{class:"stat-label"},"è´Ÿ",-1))]),b("div",X,[b("span",Y,x(_e.value.totalReward),1),a[12]||(a[12]=b("span",{class:"stat-label"},"ç„°æ™¶æ”¶ç›Š",-1))])])):z("",!0),m(be,{type:"segment",value:he.value,"onUpdate:value":a[2]||(a[2]=e=>he.value=e)},{default:h(()=>[m(ye,{name:"lobby",tab:"ðŸŸï¸ å¤§åŽ…"},{default:h(()=>[m(_,{type:"primary",block:"",onClick:Ae,loading:de.value,style:{"margin-top":"12px"}},{default:h(()=>[...a[13]||(a[13]=[w(" ðŸ”„ åˆ·æ–°åœ¨çº¿çŽ©å®¶ ",-1)])]),_:1},8,["loading"]),0===ue.value.length?(k(),y("div",Z,[a[15]||(a[15]=b("span",{style:{"font-size":"32px"}},"ðŸœï¸",-1)),m(f,{depth:"3",tag:"div",style:{"margin-top":"8px"}},{default:h(()=>[...a[14]||(a[14]=[w("æš‚æ— å…¶ä»–åœ¨çº¿çŽ©å®¶",-1)])]),_:1})])):z("",!0),(k(!0),y(C,null,B(ue.value,e=>(k(),y("div",{key:e.fullWallet,class:"player-card",style:{"margin-top":"10px"}},[b("div",ee,[b("div",ae,x(e.name[0]),1),b("div",te,[m(f,{strong:""},{default:h(()=>[w(x(e.name),1)]),_:2},1024),m(f,{depth:"3",style:{"font-size":"11px"}},{default:h(()=>[w(x(e.realm)+" Â· æˆ˜åŠ› "+x(e.combatPower),1)]),_:2},1024)])]),m(_,{type:"error",size:"small",onClick:a=>{return t=e,ie.stopAutoCultivation(),void(ge&&1===ge.readyState&&ge.send(JSON.stringify({type:"pk_challenge",targetWallet:t.fullWallet})));var t},disabled:ce.value},{default:h(()=>[w(x(ce.value?"å·²å‘é€":"âš”ï¸ æŒ‘æˆ˜"),1)]),_:1},8,["onClick","disabled"])]))),128))]),_:1}),m(ye,{name:"history",tab:"ðŸ“œ æˆ˜ç»©"},{default:h(()=>[0===ke.value.length?(k(),y("div",le,[m(f,{depth:"3"},{default:h(()=>[...a[16]||(a[16]=[w("æš‚æ— æˆ˜ç»©è®°å½•",-1)])]),_:1})])):z("",!0),(k(!0),y(C,null,B(ke.value,e=>(k(),y("div",{key:e.id,class:S(["history-item","h-"+e.isMe])},[b("div",se,[b("span",{class:S(["h-result","hr-"+e.isMe])},x("win"===e.isMe?"èƒœ":"draw"===e.isMe?"å¹³":"è´Ÿ"),3),b("div",ne,[m(f,{strong:""},{default:h(()=>[w("vs "+x(e.opponent),1)]),_:2},1024),m(f,{depth:"3",style:{"font-size":"11px"}},{default:h(()=>[w(x(we(e.created_at)),1)]),_:2},1024)])]),"win"===e.isMe?(k(),N(f,{key:0,type:"warning",style:{"font-size":"12px"}},{default:h(()=>[w("+"+x(e.reward)+" ç„°æ™¶",1)]),_:2},1024)):z("",!0)],2))),128))]),_:1})]),_:1},8,["value"])]),_:1}))]),_:1})])}}},[["__scopeId","data-v-fc5f62f9"]]);export{ie as default};
