import{o as e,aC as a,bg as l,bF as t,bE as n,r as s,q as i,bf as r,bh as o,k as u,bj as d,F as c,bk as v,aW as f,bi as p,bl as y,bn as m,b7 as w,W as h}from"./vendor-CBGg7cPT.js";import{_ as g,a as _}from"./index-C_Usn6qf.js";import{G as k}from"./GameGuide-Dc_uhL03.js";import{c as b,j as S,q as j,p as C,s as x,B as O,$ as L,I as q,J as P,t as z,m as T,L as J,M as N,w as $,O as E}from"./naive-ui-CtewNtT3.js";const U={class:"friends-page"},I={class:"friend-count"},W={key:0,class:"empty-tip"},F={class:"friend-grid"},V={class:"friend-info"},A={class:"friend-name"},B={class:"friend-detail"},G={class:"friend-detail"},M={class:"friend-actions"},D={key:0,class:"empty-tip"},H={class:"friend-grid"},K={class:"friend-info"},Q={class:"friend-name"},R={class:"friend-detail"},X={class:"friend-detail"},Y={class:"friend-actions"},Z={key:0,class:"friend-grid",style:{"margin-top":"12px"}},ee={class:"friend-info"},ae={class:"friend-name"},le={class:"friend-detail"},te={class:"friend-detail"},ne={class:"friend-actions"},se={key:0,class:"empty-tip"},ie={class:"friend-grid"},re={class:"friend-info"},oe={class:"friend-name"},ue={class:"friend-detail"},de={key:0,class:"friend-detail gift-msg"},ce={class:"friend-actions"},ve={key:0,class:"empty-tip"},fe={key:1,class:"friend-grid"},pe=["onClick"],ye={class:"friend-info"},me={class:"friend-name"},we={key:0,class:"unread-badge"},he={class:"friend-detail"},ge={class:"friend-detail"},_e={class:"friend-actions"},ke={key:0,class:"profile-modal"},be={class:"profile-row"},Se={class:"profile-row"},je={class:"profile-row"},Ce={class:"profile-row"},xe={class:"profile-row"},Oe={key:0,class:"profile-row"},Le={key:1,class:"profile-row"},qe={key:2},Pe={class:"equip-slot"},ze={key:3,class:"empty-tip"},Te={class:"gift-remaining"},Je={class:"chat-modal"},Ne={key:0,class:"empty-tip"},$e={class:"chat-bubble"},Ee={class:"chat-text"},Ue={class:"chat-time"},Ie={class:"chat-input-row"},We="/api/friend",Fe=g({__name:"Friends",setup(g){const{message:Fe}=b(["message"]),Ve=_(),Ae=s("list"),Be=s([]),Ge=s([]),Me=s(""),De=s([]),He=s(!1),Ke=s([]),Qe=s(!1),Re=s(null),Xe=s(!1),Ye=s(null),Ze=s(!1),ea=s(3),aa=s({gift_type:"spirit_stones",gift_value:100,message:""}),la=s(!1),ta=s(null),na=s([]),sa=s(""),ia=s(!1),ra=s({}),oa=s(null),ua=s(null),da=[{label:"ç„°æ™¶",value:"spirit_stones"}],ca=i(()=>Ge.value.length?`ç”³è¯·(${Ge.value.length})`:"ç”³è¯·"),va=i(()=>{const e=Object.values(ra.value).reduce((e,a)=>e+a,0);return e>0?`ç§èŠ(${e})`:"ç§èŠ"}),fa=i(()=>{if(!ta.value)return"ç§èŠ";const e=ta.value.online?"ğŸŸ¢ åœ¨çº¿":"âš« ç¦»çº¿";return`${ta.value.name} ${e}`}),pa=i(()=>{const e=Ke.value.filter(e=>!e.claimed).length;return e?`ç¤¼ç‰©(${e})`:"ç¤¼ç‰©"}),ya=i(()=>{var e;if(!(null==(e=Re.value)?void 0:e.equippedArtifacts))return[];const a=Re.value.equippedArtifacts,l={weapon:"ç„°æ–",armor:"é˜²å…·",accessory:"é¥°å“",mount:"ç„°éª‘"},t={common:"#aaa",rare:"#4fc3f7",epic:"#ab47bc",legendary:"#ffa726",mythic:"#ef5350"};return Object.entries(a).filter(([,e])=>e).map(([e,a])=>({slot:l[e]||e,name:a.name||"æœªçŸ¥",color:t[a.rarity]||"#ccc"}))});function ma(){return{Authorization:"Bearer "+Ve.token,"Content-Type":"application/json"}}async function wa(){try{const e=await fetch(We+"/list",{headers:ma()}),a=await e.json();a.ok&&(Be.value=a.friends)}catch{}}async function ha(){try{const e=await fetch(We+"/requests",{headers:ma()}),a=await e.json();a.ok&&(Ge.value=a.requests)}catch{}}async function ga(){try{const e=await fetch(We+"/gifts",{headers:ma()}),a=await e.json();a.ok&&(Ke.value=a.gifts)}catch{}}async function _a(){if(Me.value.trim()){He.value=!0;try{const e=await fetch(We+"/search",{method:"POST",headers:ma(),body:JSON.stringify({keyword:Me.value})}),a=await e.json();a.ok&&(De.value=a.players)}catch{}finally{He.value=!1}}}function ka(e){Ye.value=e,aa.value={gift_type:"spirit_stones",gift_value:100,message:""},Xe.value=!0}async function ba(){Ze.value=!0;try{const e=await fetch(We+"/gift",{method:"POST",headers:ma(),body:JSON.stringify({to_wallet:Ye.value.wallet,...aa.value})}),a=await e.json();a.ok?(Fe.success("ç¤¼ç‰©å·²é€å‡º"),ea.value=a.remaining,Xe.value=!1,wa()):Fe.warning(a.error)}catch{}finally{Ze.value=!1}}function Sa(e){return e>=1e4?(e/1e4).toFixed(1)+"ä¸‡":String(e)}function ja(e){return"spirit_stones"===e?"ç„°æ™¶":e}function Ca(){return window.__gameWs}async function xa(e){ta.value=e,la.value=!0,na.value=[],sa.value="";try{const a=await fetch(We+"/chat/"+e.wallet,{headers:ma()}),l=await a.json();l.ok&&(na.value=l.messages.map(e=>{var a;return{...e,isSelf:e.from_wallet===(null==(a=Ve.user)?void 0:a.wallet)}}),qa())}catch{}ra.value[e.wallet]&&(delete ra.value[e.wallet],ra.value={...ra.value});const a=Ca();a&&1===a.readyState&&a.send(JSON.stringify({type:"mark_read",fromWallet:e.wallet})),function(){ua.value&&window.removeEventListener("private_chat",ua.value);ua.value=e=>{var a;const l=e.detail;if(l&&"private_chat"===l.type)if(ta.value&&(l.from===ta.value.wallet||l.self)){if(na.value.push({from_wallet:l.self?null==(a=Ve.user)?void 0:a.wallet:l.from,content:l.text,created_at:new Date(l.time).toISOString(),isSelf:l.self}),qa(),!l.self&&ta.value){const e=Ca();e&&1===e.readyState&&e.send(JSON.stringify({type:"mark_read",fromWallet:l.from}))}}else if(!l.self){const e=l.from;ra.value={...ra.value,[e]:(ra.value[e]||0)+1}}},window.addEventListener("private_chat",ua.value)}()}function Oa(){ua.value&&(window.removeEventListener("private_chat",ua.value),ua.value=null),ta.value=null}async function La(){const e=sa.value.trim();if(!e||!ta.value)return;const a=Ca();a&&1===a.readyState?(ia.value=!0,a.send(JSON.stringify({type:"private_chat",toWallet:ta.value.wallet,text:e})),sa.value="",ia.value=!1):Fe.error("è¿æ¥æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•")}function qa(){h(()=>{oa.value&&(oa.value.scrollTop=oa.value.scrollHeight)})}function Pa(e){if(!e)return"";const a=new Date(e);return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}function za(e,a){const l=Be.value.find(a=>a.wallet===e);l&&(l.online=a)}function Ta(e){za(e.detail.wallet,!0)}function Ja(e){za(e.detail.wallet,!1)}return e(()=>{Ve.isLoggedIn&&(wa(),ha(),ga(),async function(){try{const e=await fetch(We+"/unread",{headers:ma()}),a=await e.json();if(a.ok){const e={};for(const l of a.unread)e[l.from_wallet]=l.count;ra.value=e}}catch{}}(),window.addEventListener("friend_online",Ta),window.addEventListener("friend_offline",Ja))}),a(()=>{ua.value&&window.removeEventListener("private_chat",ua.value),window.removeEventListener("friend_online",Ta),window.removeEventListener("friend_offline",Ja)}),(e,a)=>{const s=O,i=L,h=x,g=P,_=q,b=z,Ve=C,ua=S,Ca=T,qa=j,za=N,Ta=$,Ja=E,Na=J;return r(),l("div",U,[t(k,null,{default:n(()=>[...a[10]||(a[10]=[o("p",null,[u("ğŸ‘¥ æœ€å¤šæ·»åŠ "),o("strong",null,"50ä¸ªç„°å‹")],-1),o("p",null,"ğŸ” æœç´¢ç„°å·æ·»åŠ å¥½å‹",-1),o("p",null,"ğŸ‘€ æŸ¥çœ‹ç„°å‹è¯¦æƒ…ï¼šç­‰çº§ã€å¢ƒç•Œã€æˆ˜åŠ›ã€è£…å¤‡ã€ç„°ç›Ÿ",-1),o("p",null,[u("ğŸ æ¯æ—¥å¯"),o("strong",null,"é€ç¤¼3æ¬¡"),u("ï¼ˆç„°æ™¶ï¼‰ï¼Œä¹Ÿå¯é¢†å–å¥½å‹ç¤¼ç‰©")],-1)])]),_:1}),t(ua,{class:"main-card",bordered:!1},{header:n(()=>[a[11]||(a[11]=o("div",{class:"page-title"},"âš”ï¸ ç„°å‹ç³»ç»Ÿ",-1)),o("div",I,"ç„°å‹: "+p(Be.value.length)+"/50",1)]),default:n(()=>[t(Ve,{value:Ae.value,"onUpdate:value":a[1]||(a[1]=e=>Ae.value=e),type:"line",animated:""},{default:n(()=>[t(h,{name:"list",tab:"ç„°å‹åˆ—è¡¨"},{default:n(()=>[0===Be.value.length?(r(),l("div",W,"æš‚æ— ç„°å‹ï¼Œå¿«å»æœç´¢æ·»åŠ å§~")):d("",!0),o("div",F,[(r(!0),l(c,null,v(Be.value,e=>(r(),l("div",{key:e.wallet,class:"friend-card"},[o("div",V,[o("div",A,[o("span",{class:f(["online-dot",{online:e.online}])},null,2),u(" "+p(e.name),1)]),o("div",B,"Lv."+p(e.level)+" Â· "+p(e.realm),1),o("div",G,"æˆ˜åŠ›: "+p(Sa(e.combatPower)),1)]),o("div",M,[t(s,{size:"tiny",type:"info",quaternary:"",onClick:a=>async function(e){try{const a=await fetch(We+"/profile/"+e,{headers:ma()}),l=await a.json();l.ok?(Re.value=l.profile,Qe.value=!0):Fe.warning(l.error)}catch{}}(e.wallet)},{default:n(()=>[...a[12]||(a[12]=[u("è¯¦æƒ…",-1)])]),_:1},8,["onClick"]),t(s,{size:"tiny",type:"warning",quaternary:"",onClick:a=>ka(e)},{default:n(()=>[...a[13]||(a[13]=[u("é€ç¤¼",-1)])]),_:1},8,["onClick"]),t(i,{onPositiveClick:a=>async function(e){try{const a=await fetch(We+"/remove",{method:"POST",headers:ma(),body:JSON.stringify({wallet:e})}),l=await a.json();l.ok?(Fe.success("å·²åˆ é™¤ç„°å‹"),wa()):Fe.warning(l.error)}catch{}}(e.wallet)},{trigger:n(()=>[t(s,{size:"tiny",type:"error",quaternary:""},{default:n(()=>[...a[14]||(a[14]=[u("åˆ é™¤",-1)])]),_:1})]),default:n(()=>[u(" ç¡®å®šåˆ é™¤ç„°å‹ã€"+p(e.name)+"ã€‘ï¼Ÿ ",1)]),_:2},1032,["onPositiveClick"])])]))),128))])]),_:1}),t(h,{name:"requests",tab:ca.value},{default:n(()=>[0===Ge.value.length?(r(),l("div",D,"æš‚æ— ç„°å‹ç”³è¯·")):d("",!0),o("div",H,[(r(!0),l(c,null,v(Ge.value,e=>(r(),l("div",{key:e.id,class:"friend-card"},[o("div",K,[o("div",Q,p(e.name),1),o("div",R,"Lv."+p(e.level)+" Â· "+p(e.realm),1),o("div",X,"æˆ˜åŠ›: "+p(Sa(e.combatPower)),1)]),o("div",Y,[t(s,{size:"tiny",type:"success",onClick:a=>async function(e){try{const a=await fetch(We+"/accept",{method:"POST",headers:ma(),body:JSON.stringify({friendship_id:e})}),l=await a.json();l.ok?(Fe.success("å·²æ¥å—"),ha(),wa()):Fe.warning(l.error)}catch{}}(e.id)},{default:n(()=>[...a[15]||(a[15]=[u("æ¥å—",-1)])]),_:1},8,["onClick"]),t(s,{size:"tiny",type:"error",quaternary:"",onClick:a=>async function(e){try{const a=await fetch(We+"/reject",{method:"POST",headers:ma(),body:JSON.stringify({friendship_id:e})}),l=await a.json();l.ok?(Fe.success("å·²æ‹’ç»"),ha()):Fe.warning(l.error)}catch{}}(e.id)},{default:n(()=>[...a[16]||(a[16]=[u("æ‹’ç»",-1)])]),_:1},8,["onClick"])])]))),128))])]),_:1},8,["tab"]),t(h,{name:"search",tab:"æœç´¢æ·»åŠ "},{default:n(()=>[t(_,null,{default:n(()=>[t(g,{value:Me.value,"onUpdate:value":a[0]||(a[0]=e=>Me.value=e),placeholder:"è¾“å…¥ç„°åæœç´¢...",onKeyup:y(_a,["enter"]),clearable:""},null,8,["value"]),t(s,{type:"primary",onClick:_a,loading:He.value},{default:n(()=>[...a[17]||(a[17]=[u("æœç´¢",-1)])]),_:1},8,["loading"])]),_:1}),De.value.length?(r(),l("div",Z,[(r(!0),l(c,null,v(De.value,e=>(r(),l("div",{key:e.wallet,class:"friend-card"},[o("div",ee,[o("div",ae,p(e.name),1),o("div",le,"Lv."+p(e.level)+" Â· "+p(e.realm),1),o("div",te,"æˆ˜åŠ›: "+p(Sa(e.combatPower)),1)]),o("div",ne,[e.isFriend?(r(),m(s,{key:0,size:"tiny",disabled:""},{default:n(()=>[...a[18]||(a[18]=[u("å·²æ·»åŠ ",-1)])]),_:1})):(r(),m(s,{key:1,size:"tiny",type:"primary",onClick:a=>async function(e){try{const a=await fetch(We+"/add",{method:"POST",headers:ma(),body:JSON.stringify({to_wallet:e})}),l=await a.json();l.ok?(Fe.success("ç„°å‹ç”³è¯·å·²å‘é€"),_a()):Fe.warning(l.error)}catch{}}(e.wallet),loading:e._adding},{default:n(()=>[...a[19]||(a[19]=[u("æ·»åŠ ",-1)])]),_:1},8,["onClick","loading"]))])]))),128))])):d("",!0)]),_:1}),t(h,{name:"gifts",tab:pa.value},{default:n(()=>[0===Ke.value.length?(r(),l("div",se,"æš‚æ— ç¤¼ç‰©")):d("",!0),o("div",ie,[(r(!0),l(c,null,v(Ke.value,e=>(r(),l("div",{key:e.id,class:"friend-card gift-card"},[o("div",re,[o("div",oe,"æ¥è‡ª: "+p(e.fromName),1),o("div",ue,p(ja(e.giftType))+" x"+p(Sa(e.giftValue)),1),e.message?(r(),l("div",de,"ğŸ’¬ "+p(e.message),1)):d("",!0)]),o("div",ce,[e.claimed?(r(),m(b,{key:1,size:"small",type:"default"},{default:n(()=>[...a[21]||(a[21]=[u("å·²é¢†å–",-1)])]),_:1})):(r(),m(s,{key:0,size:"small",type:"success",onClick:a=>async function(e){try{const a=await fetch(We+"/gifts/"+e+"/claim",{method:"POST",headers:ma()}),l=await a.json();l.ok?(Fe.success(`é¢†å–äº† ${ja(l.giftType)} x${l.giftValue}`),ga()):Fe.warning(l.error)}catch{}}(e.id)},{default:n(()=>[...a[20]||(a[20]=[u("é¢†å–",-1)])]),_:1},8,["onClick"]))])]))),128))])]),_:1},8,["tab"]),t(h,{name:"chat",tab:va.value},{default:n(()=>[0===Be.value.length?(r(),l("div",ve,"æš‚æ— ç„°å‹ï¼Œå¿«å»æ·»åŠ å§~")):(r(),l("div",fe,[(r(!0),l(c,null,v(Be.value,e=>(r(),l("div",{key:e.wallet,class:"friend-card chat-friend-card",onClick:a=>xa(e)},[o("div",ye,[o("div",me,[o("span",{class:f(["online-dot",{online:e.online}])},null,2),u(" "+p(e.name)+" ",1),ra.value[e.wallet]?(r(),l("span",we,p(ra.value[e.wallet]>99?"99+":ra.value[e.wallet]),1)):d("",!0)]),o("div",he,"Lv."+p(e.level)+" Â· "+p(e.realm),1),o("div",ge,p(e.online?"ğŸŸ¢ åœ¨çº¿":"âš« ç¦»çº¿"),1)]),o("div",_e,[t(s,{size:"tiny",type:"primary",quaternary:""},{default:n(()=>[...a[22]||(a[22]=[u("ğŸ’¬ ç§èŠ",-1)])]),_:1})])],8,pe))),128))]))]),_:1},8,["tab"])]),_:1},8,["value"])]),_:1}),t(qa,{show:Qe.value,"onUpdate:show":a[3]||(a[3]=e=>Qe.value=e),preset:"card",title:"ç„°å‹è¯¦æƒ…",style:{"max-width":"420px"},bordered:!1},{default:n(()=>{return[Re.value?(r(),l("div",ke,[o("div",be,[a[23]||(a[23]=o("span",{class:"label"},"ç„°å",-1)),o("span",null,p(Re.value.name),1)]),o("div",Se,[a[24]||(a[24]=o("span",{class:"label"},"ç­‰çº§",-1)),o("span",null,"Lv."+p(Re.value.level),1)]),o("div",je,[a[25]||(a[25]=o("span",{class:"label"},"å¢ƒç•Œ",-1)),o("span",null,p(Re.value.realm),1)]),o("div",Ce,[a[26]||(a[26]=o("span",{class:"label"},"æˆ˜åŠ›",-1)),o("span",null,p(Sa(Re.value.combatPower)),1)]),o("div",xe,[a[27]||(a[27]=o("span",{class:"label"},"VIP",-1)),o("span",null,p(Re.value.vipLevel>0?"VIP"+Re.value.vipLevel:"æ— "),1)]),Re.value.sect?(r(),l("div",Oe,[a[28]||(a[28]=o("span",{class:"label"},"ç„°ç›Ÿ",-1)),o("span",null,p(Re.value.sect.name)+"("+p((e=Re.value.sect.role,{leader:"ç›Ÿä¸»",elder:"ç„°é•¿",member:"æˆå‘˜"}[e]||e))+")",1)])):(r(),l("div",Le,[...a[29]||(a[29]=[o("span",{class:"label"},"ç„°ç›Ÿ",-1),o("span",null,"æ— ",-1)])])),t(Ca,null,{default:n(()=>[...a[30]||(a[30]=[u("è£…å¤‡",-1)])]),_:1}),ya.value.length?(r(),l("div",qe,[(r(!0),l(c,null,v(ya.value,e=>(r(),l("div",{key:e.slot,class:"equip-row"},[o("span",Pe,p(e.slot),1),o("span",{class:"equip-name",style:w({color:e.color})},p(e.name),5)]))),128))])):(r(),l("div",ze,"æœªç©¿æˆ´è£…å¤‡")),t(s,{type:"warning",block:"",style:{"margin-top":"16px"},onClick:a[2]||(a[2]=e=>ka(Re.value))},{default:n(()=>[...a[31]||(a[31]=[u("ğŸ é€ç¤¼",-1)])]),_:1})])):d("",!0)];var e}),_:1},8,["show"]),t(qa,{show:Xe.value,"onUpdate:show":a[7]||(a[7]=e=>Xe.value=e),preset:"card",title:"ğŸ é€ç¤¼",style:{"max-width":"380px"},bordered:!1},{default:n(()=>[t(Na,{"label-placement":"left","label-width":"80"},{default:n(()=>[t(za,{label:"é€ç»™"},{default:n(()=>{var e;return[u(p((null==(e=Ye.value)?void 0:e.name)||"æœªçŸ¥"),1)]}),_:1}),t(za,{label:"ç±»å‹"},{default:n(()=>[t(Ta,{value:aa.value.gift_type,"onUpdate:value":a[4]||(a[4]=e=>aa.value.gift_type=e),options:da},null,8,["value"])]),_:1}),t(za,{label:"æ•°é‡"},{default:n(()=>[t(Ja,{value:aa.value.gift_value,"onUpdate:value":a[5]||(a[5]=e=>aa.value.gift_value=e),min:1,max:1e5,style:{width:"100%"}},null,8,["value"])]),_:1}),t(za,{label:"ç•™è¨€"},{default:n(()=>[t(g,{value:aa.value.message,"onUpdate:value":a[6]||(a[6]=e=>aa.value.message=e),placeholder:"å†™ç‚¹ä»€ä¹ˆ...",maxlength:"50"},null,8,["value"])]),_:1}),o("div",Te,"ä»Šæ—¥å‰©ä½™é€ç¤¼æ¬¡æ•°: "+p(ea.value)+"/3",1),t(s,{type:"warning",block:"",onClick:ba,loading:Ze.value,disabled:ea.value<=0},{default:n(()=>[...a[32]||(a[32]=[u("ç¡®è®¤é€å‡º",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["show"]),t(qa,{show:la.value,"onUpdate:show":[a[9]||(a[9]=e=>la.value=e),Oa],preset:"card",title:fa.value,style:{"max-width":"480px"},bordered:!1},{default:n(()=>{var e;return[o("div",Je,[o("div",{class:"chat-messages",ref_key:"chatMessagesBox",ref:oa},[0===na.value.length?(r(),l("div",Ne,"å¼€å§‹å’Œ "+p(null==(e=ta.value)?void 0:e.name)+" èŠå¤©å§~",1)):d("",!0),(r(!0),l(c,null,v(na.value,(e,a)=>(r(),l("div",{key:a,class:f(["chat-msg-row",{self:e.isSelf}])},[o("div",$e,[o("div",Ee,p(e.content),1),o("div",Ue,p(Pa(e.created_at)),1)])],2))),128))],512),o("div",Ie,[t(g,{value:sa.value,"onUpdate:value":a[8]||(a[8]=e=>sa.value=e),placeholder:"è¾“å…¥æ¶ˆæ¯...",maxlength:"500",onKeyup:y(La,["enter"])},null,8,["value"]),t(s,{type:"primary",onClick:La,loading:ia.value},{default:n(()=>[...a[33]||(a[33]=[u("å‘é€",-1)])]),_:1},8,["loading"])])])]}),_:1},8,["show","title"])])}}},[["__scopeId","data-v-f987f8f2"]]);export{Fe as default};
